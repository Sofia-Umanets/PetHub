{% extends '_base.html' %}
{% load static %}
{% block title %}{{ pet.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pets.css' %}">
{% endblock %}

{% block content %}
<div class="pet-card">
    <h1>{{ pet.name }}</h1>
    
    <div class="pet-info">
        <p><strong>–¢–∏–ø –∂–∏–≤–æ—Ç–Ω–æ–≥–æ:</strong> {{ pet.display_pet_type }}</p>
        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ pet.age }}</p>
        {% if pet.breed %}
            <p><strong>–ü–æ—Ä–æ–¥–∞:</strong> {{ pet.breed }}</p>
        {% endif %}

        {% if pet.gender %}
            <p><strong>–ü–æ–ª:</strong> {{ pet.get_gender_display }}</p>
        {% endif %}

        {% if pet.weight %}
            <p><strong>–í–µ—Å:</strong> {{ pet.weight }} –∫–≥</p>
        {% endif %}
        
        {% if pet.features %}
            <details>
                <summary><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</strong> (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>
                <div class="pet-features">
                    <div class="features-content">{{ pet.features }}</div>
                </div>
            </details>
        {% endif %}
    </div>

    {% if pet.photo %}
        <img src="{{ pet.photo.url }}" alt="{{ pet.name }}" class="pet-photo">
    {% else %}
        <img src="{% static 'img/pet_placeholder.jpg' %}" alt="–ü–∏—Ç–æ–º–µ—Ü" class="pet-photo">
    {% endif %}
</div>

<div class="tabs">
    <a href="?tab=info" class="{% if tab == 'info' %}active{% endif %}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
    <a href="?tab=calendar" class="{% if tab == 'calendar' %}active{% endif %}">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
</div>

<div class="tab-content">
    {% if tab == 'info' %}
        <p><strong>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ pet.birthday|date:"d.m.Y" }}</p>
        {% if birthday_today %}
            <p><strong>üéâ –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É {{ pet.name }}!</strong></p>
        {% elif birthday_soon %}
            <p><strong>‚è≥ –ß–µ—Ä–µ–∑ {{ birthday_soon }} –¥–Ω–µ–π —É {{ pet.name }} –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è!</strong></p>
        {% endif %}

        <p><strong>–í–ª–∞–¥–µ–ª—å—Ü—ã:</strong></p>
        <ul>
            {% for owner in pet.owners.all %}
                <li>
                    {{ owner.email }}
                    {% if is_creator and owner != user and pet.owners.count > 1 %}
                        <form method="post" action="{% url 'pets:remove_owner' pet.id owner.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-small btn-danger" 
                                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ owner.email }} –∏–∑ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤?')">
                                ‚úï –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="action-buttons">
            {% if is_creator %}
                <a href="{% url 'pets:edit' pet.id %}" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'invite_owner' pet.id %}" class="btn">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞</a>
            {% endif %}
        </div>

    {% elif tab == 'calendar' %}

        <div id="calendar"></div>
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <div id="eventModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>–°–æ–±—ã—Ç–∏—è –Ω–∞ <span id="eventDate"></span></h2>
                <div id="eventList"></div>
            </div>
        </div>

        <p style="margin-top: 20px;">
            <a href="{% url 'calendarapp:add' pet.id %}" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</a>
        </p>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
    
    <script>
        var calendarEvents = [
            {% for event in events %}
            {
                title: '{{ event.title }}{% if event.is_done %} ‚úÖ{% endif %}',
                start: '{{ event.date|date:"Y-m-d" }}',
                end: '{{ event.date|date:"Y-m-d" }}',
                className: '{{ event.is_done|yesno:"done,not-done" }}',
                backgroundColor: '{{ event.is_done|yesno:"rgb(128, 238, 114),#ffffff" }}',
                textColor: '{{ event.is_done|yesno:"#000000,#000000" }}',
                borderColor: '{{ event.is_done|yesno:"rgb(100, 200, 100),#ddd" }}',
                extendedProps: {
                    id: '{{ event.id }}',
                    time: '{{ event.time|default:"" }}',
                    note: `{{ event.note|default_if_none:"" }}`,
                    is_done: {{ event.is_done|yesno:"true,false" }},
                    remind: `{% if event.reminder %}{{ event.reminder.remind_at|time:"H:i" }}{% endif %}`,
                    is_yearly: {{ event.is_yearly|yesno:"true,false" }},
                    edit_url: '{% url 'calendarapp:edit' event.id %}',
                    done_url: '{% url 'calendarapp:done' event.id %}',
                    delete_url: '{% url 'calendarapp:delete' event.id %}'
                }
            },
            {% endfor %}
        ];
        var csrfToken = "{{ csrf_token }}";
    </script>
    <script src="{% static 'js/pet_calendar.js' %}"></script>
    
    <style>
        .fc-event, 
        .fc-event-dot,
        .fc-daygrid-event {
            background-color: #ffffff !important;
            color: #000000 !important;
            border-color: #ddd !important;
        }
        
        .fc-event.done, 
        .fc-event-dot.done,
        .fc-daygrid-event.done {
            background-color: rgb(128, 238, 114) !important;
            color: #000000 !important;
            border-color: rgb(100, 200, 100) !important;
        }
        
        .fc-h-event {
            background-color: inherit !important;
            border-color: inherit !important;
        }
        
        .fc-daygrid-event-dot {
            border-color: inherit !important;
        }
    </style>
    
    {% endif %}
</div>
{% endblock %}